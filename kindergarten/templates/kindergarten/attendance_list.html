{% extends 'kindergarten/base.html' %}

{% block title %}Посещаемость{% endblock %}

{% block content %}
<h1>Журнал посещаемости</h1>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="date" class="form-label">Дата:</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ filter_date|date:'Y-m-d' }}">
            </div>
            
            <div class="col-md-4">
                <label for="group" class="form-label">Группа: <span class="text-danger">*</span></label>
                <select class="form-select" id="group" name="group" required>
                    <option value="">-- Выберите группу --</option>
                    {% for group in groups %}
                    <option value="{{ group.group_id }}" 
                            {% if group_filter|stringformat:"s" == group.group_id|stringformat:"s" %}selected{% endif %}>
                        {{ group.group_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-filter"></i> Применить
                </button>
                <a href="{% url 'attendance_list' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Сбросить
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Форма массовой отметки -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-calendar-check"></i> 
            {% if group_filter and groups|length > 0 %}
                {% for group in groups %}
                    {% if group.group_id|stringformat:"s" == group_filter %}
                        Отметка посещаемости для {{ group.group_name }}
                    {% endif %}
                {% endfor %}
            {% else %}
                Отметка посещаемости
            {% endif %}
            <small class="text-muted">{{ filter_date|date:"d.m.Y" }}</small>
        </h5>
    </div>
    
    {% if group_filter %}
        {% if students_with_attendance %}
        <form method="post" action="{% url 'attendance_mark_bulk' %}" id="attendanceForm">
            {% csrf_token %}
            <input type="hidden" name="date" value="{{ filter_date|date:'Y-m-d' }}">
            <input type="hidden" name="group_id" value="{{ group_filter }}">
        
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Ученик</th>
                            <th>Группа</th>
                            <th>Статус</th>
                            <th>Причина отсутствия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in students_with_attendance %}
                        {% with student=item.student attendance_record=item.attendance_record %}
                        <tr>
                            <td>
                                <a href="{% url 'student_detail' student.pk %}">
                                    {{ student.student_fio }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    {{ student.group.group_name|default:"-" }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.pk }}" 
                                           id="present_{{ student.pk }}" 
                                           value="true" 
                                           autocomplete="off"
                                           {% if not attendance_record or attendance_record.status %}checked{% endif %}>
                                    <label class="btn btn-outline-success" for="present_{{ student.pk }}">
                                        <i class="bi bi-check-circle"></i> Присутствует
                                    </label>
                                    
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.pk }}" 
                                           id="absent_{{ student.pk }}" 
                                           value="false" 
                                           autocomplete="off"
                                           {% if attendance_record and not attendance_record.status %}checked{% endif %}>
                                    <label class="btn btn-outline-danger" for="absent_{{ student.pk }}">
                                        <i class="bi bi-x-circle"></i> Отсутствует
                                    </label>
                                </div>
                            </td>
                            <td>
                                <select class="form-control form-control-sm reason-select 
                                               {% if attendance_record and not attendance_record.status %}d-block{% else %}d-none{% endif %}" 
                                        name="reason_{{ student.pk }}">
                                    <option value="">Не указана</option>
                                    <option value="Болезнь" 
                                            {% if attendance_record and attendance_record.reason == 'Болезнь' %}selected{% endif %}>
                                        Болезнь
                                    </option>
                                    <option value="Отпуск" 
                                            {% if attendance_record and attendance_record.reason == 'Отпуск' %}selected{% endif %}>
                                        Отпуск родителей
                                    </option>
                                    <option value="Семейные обстоятельства" 
                                            {% if attendance_record and attendance_record.reason == 'Семейные обстоятельства' %}selected{% endif %}>
                                        Семейные обстоятельства
                                    </option>
                                    <option value="Другое" 
                                            {% if attendance_record and attendance_record.reason == 'Другое' %}selected{% endif %}>
                                        Другое
                                    </option>
                                </select>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <div id="saveStatus" class="alert alert-info d-none" role="alert">
                    <i class="bi bi-info-circle"></i> <span id="saveMessage">Автосохранение...</span>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> Сохранить все
                </button>
            </div>
        </div>
        </form>
        {% else %}
        <div class="card-body">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle fs-1"></i>
                <h5 class="mt-3">Нет учеников</h5>
                <p>В выбранной группе нет учеников или все уже отмечены.</p>
            </div>
        </div>
        {% endif %}
    {% else %}
    <div class="card-body">
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-triangle fs-1"></i>
            <h4 class="mt-3">Выберите группу</h4>
            <p>Для работы с посещаемостью необходимо выбрать группу из списка выше.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Автосохранение посещаемости
document.addEventListener('DOMContentLoaded', function() {
    let saveTimeout;
    const saveStatus = document.getElementById('saveStatus');
    const saveMessage = document.getElementById('saveMessage');
    
    function showSaveStatus(message, type = 'info') {
        saveStatus.className = `alert alert-${type}`;
        saveStatus.classList.remove('d-none');
        saveMessage.textContent = message;
        
        setTimeout(() => {
            saveStatus.classList.add('d-none');
        }, 3000);
    }
    
    function autoSave() {
        const form = document.getElementById('attendanceForm');
        if (!form) return;
        
        const formData = new FormData(form);
        showSaveStatus('Сохранение...', 'info');
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (response.ok) {
                showSaveStatus('✓ Сохранено', 'success');
            } else {
                showSaveStatus('✗ Ошибка сохранения', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSaveStatus('✗ Ошибка сохранения', 'danger');
        });
    }
    
    function scheduleAutoSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(autoSave, 1000);
    }
    
    // Обработка радиокнопок с автосохранением
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const studentId = this.name.replace('status_', '');
            const reasonSelect = document.querySelector(`select[name="reason_${studentId}"]`);
            
            if (reasonSelect) {
                if (this.value === 'false') {
                    reasonSelect.classList.remove('d-none');
                    reasonSelect.classList.add('d-block');
                } else {
                    reasonSelect.classList.remove('d-block');
                    reasonSelect.classList.add('d-none');
                    reasonSelect.value = '';
                }
            }
            
            // Автосохранение при изменении статуса
            scheduleAutoSave();
        });
    });
    
    // Автосохранение при изменении причины
    document.querySelectorAll('.reason-select').forEach(select => {
        select.addEventListener('change', function() {
            scheduleAutoSave();
        });
    });
    
    // Инициализация состояния при загрузке
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const studentId = radio.name.replace('status_', '');
        const reasonSelect = document.querySelector(`select[name="reason_${studentId}"]`);
        
        if (reasonSelect && radio.value === 'false') {
            reasonSelect.classList.remove('d-none');
            reasonSelect.classList.add('d-block');
        }
    });
    
    // Предзаполнение сегодняшней даты если не выбрана
    const dateInput = document.getElementById('date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Автоматическое обновление при изменении даты или группы
    const dateSelect = document.getElementById('date');
    const groupSelect = document.getElementById('group');
    
    if (dateSelect) {
        dateSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    if (groupSelect) {
        groupSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
});
</script>

<style>
/* Стили для улучшения UX */
.btn-check:checked + .btn-outline-success {
    background-color: var(--bs-success);
    color: white;
}

.btn-check:checked + .btn-outline-danger {
    background-color: var(--bs-danger);
    color: white;
}

.reason-select {
    transition: all 0.3s ease;
    max-width: 200px;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}