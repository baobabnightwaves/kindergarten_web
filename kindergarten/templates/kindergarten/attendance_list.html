{% extends 'kindergarten/base.html' %}

{% block title %}–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å{% endblock %}

{% block content %}
<h1>–ñ—É—Ä–Ω–∞–ª –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h1>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="date" class="form-label">–î–∞—Ç–∞:</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ filter_date|date:'Y-m-d' }}">
            </div>
            
            <div class="col-md-4">
                <label for="group" class="form-label">–ì—Ä—É–ø–ø–∞: <span class="text-danger">*</span></label>
                <select class="form-select" id="group" name="group" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
                    {% for group in groups %}
                    <option value="{{ group.group_id }}" 
                            {% if group_filter|stringformat:"s" == group.group_id|stringformat:"s" %}selected{% endif %}>
                        {{ group.group_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <a href="{% url 'attendance_list' %}" class="btn btn-secondary">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–º–µ—Ç–∫–∏ -->
<div class="card mb-4">
    <div class="card-header {% if is_weekend %}bg-secondary text-white{% endif %}">
        <h5 class="mb-0">
            {% if group_filter and groups|length > 0 %}
                {% for group in groups %}
                    {% if group.group_id|stringformat:"s" == group_filter %}
                        –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –¥–ª—è {{ group.group_name }}
                    {% endif %}
                {% endfor %}
            {% else %}
                –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
            {% endif %}
            <small class="{% if is_weekend %}text-white{% else %}text-muted{% endif %}">{{ filter_date|date:"d.m.Y" }}</small>
            {% if is_weekend %}
                <span class="badge bg-warning text-dark ms-2">–í–´–•–û–î–ù–û–ô –î–ï–ù–¨</span>
            {% endif %}
        </h5>
    </div>
    
    {% if is_weekend %}
    <div class="card-body">
        <div class="alert alert-warning text-center">
            <h4 class="mt-3">–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å</h4>
            <p>{{ filter_date|date:"d.m.Y" }} - —ç—Ç–æ {% if filter_date.weekday == 5 %}—Å—É–±–±–æ—Ç–∞{% else %}–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ{% endif %}. –î–µ—Ç—Å–∫–∏–π —Å–∞–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏.</p>
            <p class="mb-0">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞) –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.</p>
        </div>
    </div>
    {% elif group_filter %}
        {% if students_with_attendance %}
        <form method="post" action="{% url 'attendance_mark_bulk' %}" id="attendanceForm">
            {% csrf_token %}
            <input type="hidden" name="date" value="{{ filter_date|date:'Y-m-d' }}">
            <input type="hidden" name="group_id" value="{{ group_filter }}">
        
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>–£—á–µ–Ω–∏–∫</th>
                            <th>–ì—Ä—É–ø–ø–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in students_with_attendance %}
                        {% with student=item.student attendance_record=item.attendance_record %}
                        <tr>
                            <td>
                                <a href="{% url 'student_detail' student.pk %}">
                                    {{ student.student_fio }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    {{ student.group.group_name|default:"-" }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.pk }}" 
                                           id="present_{{ student.pk }}" 
                                           value="true" 
                                           autocomplete="off"
                                           {% if not attendance_record or attendance_record.status %}checked{% endif %}>
                                    <label class="btn btn-outline-success" for="present_{{ student.pk }}">
                                        –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                                    </label>
                                    
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.pk }}" 
                                           id="absent_{{ student.pk }}" 
                                           value="false" 
                                           autocomplete="off"
                                           {% if attendance_record and not attendance_record.status %}checked{% endif %}>
                                    <label class="btn btn-outline-danger" for="absent_{{ student.pk }}">
                                        –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                                    </label>
                                </div>
                            </td>
                            <td>
                                <select class="form-control form-control-sm reason-select" 
                                        name="reason_{{ student.pk }}"
                                        {% if not attendance_record or attendance_record.status %}disabled{% endif %}>
                                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                                    <option value="–ë–æ–ª–µ–∑–Ω—å" 
                                            {% if attendance_record and attendance_record.reason == '–ë–æ–ª–µ–∑–Ω—å' %}selected{% endif %}>
                                        –ë–æ–ª–µ–∑–Ω—å
                                    </option>
                                    <option value="–û—Ç–ø—É—Å–∫" 
                                            {% if attendance_record and attendance_record.reason == '–û—Ç–ø—É—Å–∫' %}selected{% endif %}>
                                        –û—Ç–ø—É—Å–∫ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
                                    </option>
                                    <option value="–°–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞" 
                                            {% if attendance_record and attendance_record.reason == '–°–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞' %}selected{% endif %}>
                                        –°–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞
                                    </option>
                                    <option value="–î—Ä—É–≥–æ–µ" 
                                            {% if attendance_record and attendance_record.reason == '–î—Ä—É–≥–æ–µ' %}selected{% endif %}>
                                        –î—Ä—É–≥–æ–µ
                                    </option>
                                </select>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <div id="saveStatus" class="alert alert-info d-none" role="alert">
                    <span id="saveMessage">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                </div>
                <button type="submit" class="btn btn-success">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
                </button>
            </div>
        </div>
        </form>
        {% else %}
        <div class="card-body">
            <div class="alert alert-info text-center">
                <h5 class="mt-3">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</h5>
                <p>–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –∏–ª–∏ –≤—Å–µ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω—ã.</p>
            </div>
        </div>
        {% endif %}
    {% else %}
    <div class="card-body">
        <div class="alert alert-warning text-center">
            <h4 class="mt-3">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</h4>
            <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
document.addEventListener('DOMContentLoaded', function() {
    let saveTimeout;
    const saveStatus = document.getElementById('saveStatus');
    const saveMessage = document.getElementById('saveMessage');
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π –≤ date picker
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.addEventListener('input', function() {
            const selectedDate = new Date(this.value);
            const dayOfWeek = selectedDate.getDay(); // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 6 = —Å—É–±–±–æ—Ç–∞
            
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                alert('–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (—Å—É–±–±–æ—Ç–∞ –∏–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ).\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.');
                this.value = '{{ today|date:"Y-m-d" }}'; // –°–±—Ä–æ—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
            }
        });
    }
    
    function showSaveStatus(message, type = 'info') {
        saveStatus.className = `alert alert-${type}`;
        saveStatus.classList.remove('d-none');
        saveMessage.textContent = message;
        
        setTimeout(() => {
            saveStatus.classList.add('d-none');
        }, 3000);
    }
    
    function autoSave() {
        const form = document.getElementById('attendanceForm');
        if (!form) return;
        
        const formData = new FormData(form);
        showSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (response.ok) {
                showSaveStatus('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            } else {
                showSaveStatus('‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSaveStatus('‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
        });
    }
    
    function scheduleAutoSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(autoSave, 1000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–∏—á–∏–Ω—ã
    function updateReasonSelectState(studentId) {
        const reasonSelect = document.querySelector(`select[name="reason_${studentId}"]`);
        const absentRadio = document.querySelector(`input[name="status_${studentId}"][value="false"]`);
        
        if (reasonSelect && absentRadio) {
            if (absentRadio.checked) {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–∏ "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
                reasonSelect.disabled = false;
            } else {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–∏ "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
                reasonSelect.value = '';
                reasonSelect.disabled = true;
            }
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Å–µ–ª–µ–∫—Ç–æ–≤ –ø—Ä–∏—á–∏–Ω
    document.querySelectorAll('.reason-select').forEach(select => {
        const studentId = select.name.replace('reason_', '');
        updateReasonSelectState(studentId);
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const studentId = this.name.replace('status_', '');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–∏—á–∏–Ω—ã
            updateReasonSelectState(studentId);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
            scheduleAutoSave();
        });
    });
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏—á–∏–Ω—ã
    document.querySelectorAll('.reason-select').forEach(select => {
        select.addEventListener('change', function() {
            scheduleAutoSave();
        });
    });
    
    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –∏–ª–∏ –≥—Ä—É–ø–ø—ã
    const groupSelect = document.getElementById('group');
    
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    if (groupSelect) {
        groupSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    console.log('‚úÖ Attendance list initialized');
    console.log('üìä –ù–∞–π–¥–µ–Ω–æ —Å–µ–ª–µ–∫—Ç–æ–≤ –ø—Ä–∏—á–∏–Ω:', document.querySelectorAll('.reason-select').length);
    console.log('üìä –ù–∞–π–¥–µ–Ω–æ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫:', document.querySelectorAll('input[type="radio"]').length);
});
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX */
.btn-check:checked + .btn-outline-success {
    background-color: var(--bs-success);
    color: white;
}

.btn-check:checked + .btn-outline-danger {
    background-color: var(--bs-danger);
    color: white;
}

.reason-select {
    transition: all 0.3s ease;
    max-width: 200px;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}