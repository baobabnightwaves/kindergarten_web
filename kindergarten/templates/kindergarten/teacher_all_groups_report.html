{% extends 'kindergarten/base.html' %}
{% load static %}

{% block title %}Отчет по группам воспитателя{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line"></i> Отчет по всем группам воспитателя</h2>
        <a href="?{% for key, value in request.GET.items %}{% if key != 'format' %}{{ key }}={{ value }}&{% endif %}{% endfor %}format=csv" class="btn btn-success">
            <i class="fas fa-file-csv"></i> Экспорт в CSV
        </a>
    </div>
    <hr>

    {% if report_data %}
        <!-- Teacher Info -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chalkboard-teacher"></i> Информация о воспитателе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>ФИО:</strong><br>
                        <h4>{{ report_data.teacher_info.fio }}</h4>
                    </div>
                    <div class="col-md-4">
                        <strong>Должность:</strong><br>
                        <span class="badge bg-primary p-2">{{ report_data.teacher_info.position }}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Телефон:</strong><br>
                        <i class="fas fa-phone"></i> {{ report_data.teacher_info.phone }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <i class="fas fa-users fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.total_groups }}</h3>
                        <p class="mb-0">Всего групп</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <i class="fas fa-user-graduate fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.total_students }}</h3>
                        <p class="mb-0">Всего учеников</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <i class="fas fa-chart-pie fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.avg_fill_percentage }}%</h3>
                        <p class="mb-0">Средняя заполненность</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.avg_attendance_percentage }}%</h3>
                        <p class="mb-0">Средняя посещаемость</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Посещаемость за последние 30 дней</h5>
                    </div>
                    <div class="card-body">
                        {% if report_data.chart_data.labels %}
                            <canvas id="attendanceBarChart" height="250"></canvas>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Нет данных о посещаемости
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Процент посещаемости (тренд)</h5>
                    </div>
                    <div class="card-body">
                        {% if report_data.chart_data.labels %}
                            <canvas id="attendanceLineChart" height="250"></canvas>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Нет данных о посещаемости
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Groups Table -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-table"></i> Наполняемость групп</h5>
            </div>
            <div class="card-body">
                {% if report_data.groups_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Название группы</th>
                                    <th>Категория</th>
                                    <th>Учеников</th>
                                    <th>Вместимость</th>
                                    <th>Заполненность</th>
                                    <th>Посещаемость (месяц)</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in report_data.groups_data %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><strong>{{ group.name }}</strong></td>
                                        <td>
                                            <span class="badge bg-secondary">{{ group.category }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ group.students_count }}</span>
                                        </td>
                                        <td>{{ group.max_capacity }}</td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar 
                                                    {% if group.fill_percentage >= 90 %}bg-danger
                                                    {% elif group.fill_percentage >= 70 %}bg-warning
                                                    {% else %}bg-success
                                                    {% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ group.fill_percentage }}%">
                                                    {{ group.fill_percentage }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {{ group.students_count }} / {{ group.max_capacity }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar 
                                                    {% if group.attendance_percentage >= 80 %}bg-success
                                                    {% elif group.attendance_percentage >= 60 %}bg-warning
                                                    {% else %}bg-danger
                                                    {% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ group.attendance_percentage }}%">
                                                    {{ group.attendance_percentage }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                Присутствовало: {{ group.attendance_present }} / 
                                                Отсутствовало: {{ group.attendance_absent }}
                                            </small>
                                        </td>
                                        <td>
                                            <a href="{% url 'report_group' %}?group_id={{ group.id }}" 
                                               class="btn btn-sm btn-primary" 
                                               title="Подробный отчет по группе">
                                                <i class="fas fa-eye"></i> Подробнее
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3">ИТОГО:</th>
                                    <th><span class="badge bg-info">{{ report_data.overall_statistics.total_students }}</span></th>
                                    <th>{{ report_data.overall_statistics.total_capacity }}</th>
                                    <th>
                                        <strong>{{ report_data.overall_statistics.avg_fill_percentage }}%</strong>
                                    </th>
                                    <th>
                                        <strong>{{ report_data.overall_statistics.avg_attendance_percentage }}%</strong>
                                        <br>
                                        <small class="text-muted">
                                            ({{ report_data.overall_statistics.month_present }} / {{ report_data.overall_statistics.month_total }})
                                        </small>
                                    </th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> У воспитателя нет закрепленных групп
                    </div>
                {% endif %}
            </div>
        </div>

    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Ошибка загрузки данных отчета
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'reports_selector' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Назад к выбору отчета
        </a>
    </div>
</div>

{% if report_data and report_data.chart_data.labels %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bar Chart: Attendance count
    const ctx1 = document.getElementById('attendanceBarChart');
    
    const barData = {
        labels: {{ report_data.chart_data.labels|safe }},
        datasets: [
            {
                label: 'Присутствовали',
                data: {{ report_data.chart_data.present|safe }},
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2
            },
            {
                label: 'Отсутствовали',
                data: {{ report_data.chart_data.absent|safe }},
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2
            }
        ]
    };

    new Chart(ctx1, {
        type: 'bar',
        data: barData,
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Количество учеников'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Дата'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                }
            }
        }
    });

    // Line Chart: Attendance percentage
    const ctx2 = document.getElementById('attendanceLineChart');
    
    const lineData = {
        labels: {{ report_data.chart_data.labels|safe }},
        datasets: [
            {
                label: 'Процент посещаемости',
                data: {{ report_data.chart_data.percentage|safe }},
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }
        ]
    };

    new Chart(ctx2, {
        type: 'line',
        data: lineData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
                padding: {
                    top: 20,
                    bottom: 10
                }
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grace: '5%',
                    title: {
                        display: true,
                        text: 'Посещаемость (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Дата'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endif %}

<style>
.progress {
    margin-bottom: 0;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

.table th {
    font-weight: 600;
}

.badge {
    font-size: 0.9em;
}
</style>
{% endblock %}
