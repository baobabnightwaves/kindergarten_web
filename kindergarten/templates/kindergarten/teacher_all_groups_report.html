{% extends 'kindergarten/base.html' %}
{% load static %}

{% block title %}Отчет по группам воспитателя{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="mb-4">
        <h2 class="mb-3"><i class="fas fa-chart-line"></i> Отчет по всем группам воспитателя</h2>
        <div class="d-flex gap-2">
            <a href="{% url 'reports_selector' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к выбору отчета
            </a>
            <a href="?{% for key, value in request.GET.items %}{% if key != 'format' %}{{ key }}={{ value }}&{% endif %}{% endfor %}format=csv" class="btn btn-success">
                <i class="fas fa-file-csv"></i> Экспорт в CSV
            </a>
        </div>
    </div>
    <hr>

    {% if report_data %}
        <!-- Overall Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <i class="fas fa-users fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.total_groups }}</h3>
                        <p class="mb-0">Всего групп</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <i class="fas fa-user-graduate fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.total_students }}</h3>
                        <p class="mb-0">Всего учеников</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <i class="fas fa-chart-pie fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.avg_fill_percentage }}%</h3>
                        <p class="mb-0">Средняя заполненность</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-3x mb-2"></i>
                        <h3>{{ report_data.overall_statistics.avg_attendance_percentage }}%</h3>
                        <p class="mb-0">Средняя посещаемость</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Посещаемость за последние 30 дней</h5>
                    </div>
                    <div class="card-body">
                        {% if report_data.chart_data.labels %}
                            <canvas id="attendanceBarChart" height="250"></canvas>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Нет данных о посещаемости
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Процент посещаемости (тренд)</h5>
                    </div>
                    <div class="card-body">
                        {% if report_data.chart_data.labels %}
                            <canvas id="attendanceLineChart" height="250"></canvas>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Нет данных о посещаемости
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Gender Pie -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-venus-mars"></i> Соотношение мальчиков и девочек</h5>
                    </div>
                    <div class="card-body">
                        {% if report_data.gender_distribution %}
                            <div class="row align-items-center">
                                <div class="col-7">
                                    <canvas id="teacherGenderPieChart" height="140"></canvas>
                                </div>
                                <div class="col-5">
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><span class="badge bg-info me-2">М</span> Мальчики</span>
                                            <span class="badge bg-info rounded-pill">{{ report_data.gender_distribution.male }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><span class="badge bg-danger me-2">Ж</span> Девочки</span>
                                            <span class="badge bg-danger rounded-pill">{{ report_data.gender_distribution.female }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> Нет данных о поле учеников
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Groups Table -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-table"></i> Наполняемость групп</h5>
            </div>
            <div class="card-body">
                {% if report_data.groups_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover sortable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="no-sort">#</th>
                                    <th>Название группы</th>
                                    <th>Категория</th>
                                    <th>Кол-во учеников</th>
                                    <th>Заполненность (%)</th>
                                    <th>Посещаемость (месяц)</th>
                                    <th class="no-sort">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in report_data.groups_data %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><strong>{{ group.name }}</strong></td>
                                        <td>
                                            <span class="badge bg-secondary">{{ group.category }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ group.students_count }}/30</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ group.fill_percentage }}%</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar 
                                                    {% if group.attendance_percentage >= 80 %}bg-success
                                                    {% elif group.attendance_percentage >= 60 %}bg-warning
                                                    {% else %}bg-danger
                                                    {% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ group.attendance_percentage }}%">
                                                    {{ group.attendance_percentage }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                Присутствовало: {{ group.attendance_present }} / 
                                                Отсутствовало: {{ group.attendance_absent }}
                                            </small>
                                        </td>
                                        <td>
                                            <a href="{% url 'report_group' %}?group_id={{ group.id }}" 
                                               class="btn btn-sm btn-primary" 
                                               title="Подробный отчет по группе">
                                                <i class="fas fa-eye"></i> Подробнее
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3">ИТОГО:</th>
                                    <th><span class="badge bg-info">{{ report_data.overall_statistics.total_students }}</span></th>
                                    <th><span class="badge bg-secondary">{{ report_data.overall_statistics.avg_fill_percentage }}%</span></th>
                                    <th>
                                        <strong>{{ report_data.overall_statistics.avg_attendance_percentage }}%</strong>
                                        <br>
                                        <small class="text-muted">
                                            ({{ report_data.overall_statistics.month_present }} / {{ report_data.overall_statistics.month_total }})
                                        </small>
                                    </th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> У воспитателя нет закрепленных групп
                    </div>
                {% endif %}
            </div>
        </div>

    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Ошибка загрузки данных отчета
        </div>
    {% endif %}
</div>

{% if report_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endif %}

{% if report_data and report_data.chart_data.labels %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bar Chart: Attendance count
    const ctx1 = document.getElementById('attendanceBarChart');
    
    const barData = {
        labels: {{ report_data.chart_data.labels|safe }},
        datasets: [
            {
                label: 'Присутствовали',
                data: {{ report_data.chart_data.present|safe }},
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2
            },
            {
                label: 'Отсутствовали',
                data: {{ report_data.chart_data.absent|safe }},
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2
            }
        ]
    };

    new Chart(ctx1, {
        type: 'bar',
        data: barData,
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Количество учеников'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Дата'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                }
            }
        }
    });

    // Line Chart: Attendance percentage
    const ctx2 = document.getElementById('attendanceLineChart');
    
    const lineData = {
        labels: {{ report_data.chart_data.labels|safe }},
        datasets: [
            {
                label: 'Процент посещаемости',
                data: {{ report_data.chart_data.percentage|safe }},
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }
        ]
    };

    new Chart(ctx2, {
        type: 'line',
        data: lineData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
                padding: {
                    top: 20,
                    bottom: 10
                }
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: 105,
                    title: {
                        display: true,
                        text: 'Посещаемость (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Дата'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
    // Gender Pie Chart
});
</script>
{% endif %}

{% if report_data and report_data.gender_distribution %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const genderCanvas = document.getElementById('teacherGenderPieChart');
    if (genderCanvas && window.Chart) {
        const male = {{ report_data.gender_distribution.male|default:0 }};
        const female = {{ report_data.gender_distribution.female|default:0 }};
        new Chart(genderCanvas.getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Мальчики', 'Девочки'],
                datasets: [{
                    data: [male, female],
                    backgroundColor: ['#0d6efd', '#dc3545'],
                    borderColor: ['#0b5ed7', '#bb2d3b'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const total = male + female || 1;
                                const val = ctx.parsed;
                                const percent = (val / total * 100).toFixed(1);
                                return ctx.label + ': ' + val + ' (' + percent + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}

<style>
.progress {
    margin-bottom: 0;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

.table th {
    font-weight: 600;
}

.badge {
    font-size: 0.9em;
}
</style>
{% endblock %}
